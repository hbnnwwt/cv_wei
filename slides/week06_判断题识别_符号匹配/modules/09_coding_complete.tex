%===========================================================
% 08_coding_complete.tex - Live Coding: 完整识别流程
%===========================================================
\section{Live Coding: 完整流程}

\begin{frame}[fragile]{完整识别流程}
    \begin{lstlisting}[basicstyle=\ttfamily\scriptsize]
def recognize_tf_symbol(image, symbol_position):
    """
    判断题符号识别完整流程

    Args:
        image: 输入图像
        symbol_position: 符号位置 (x, y, w, h)

    Returns:
        符号类型和置信度
    """
    # 1. 提取符号区域
    x, y, w, h = symbol_position
    roi = image[y:y+h, x:x+w]

    # 2. 预处理
    gray = cv2.cvtColor(roi, cv2.COLOR_BGR2GRAY)
    _, binary = cv2.threshold(gray, 0, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)

    # 3. 查找轮廓
    contours, _ = cv2.findContours(binary, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

    if len(contours) == 0:
        return 'empty', 0.0

    # 4. 获取最大轮廓
    contour = max(contours, key=cv2.contourArea)

    # 5. 提取特征
    features = extract_features(contour)

    # 6. 分类
    symbol_type = classify_by_features(features)

    # 7. 计算置信度（基于特征）
    confidence = calculate_confidence(features, symbol_type)

    return symbol_type, confidence
    \end{lstlisting}
\end{frame}

\begin{frame}[fragile]{置信度计算}
    \begin{lstlisting}[basicstyle=\ttfamily\scriptsize]
def calculate_confidence(features, symbol_type):
    """计算识别置信度"""
    confidence = 0.0

    if symbol_type == 'check':
        # 对号：高凸性区分度
        confidence = 1.0 - features['convexity']
    elif symbol_type == 'cross':
        # 错号：低圆度区分度
        confidence = 1.0 - features['circularity']
    elif symbol_type == 'circle':
        # 圆圈：圆度接近1
        confidence = features['circularity']

    return max(0, min(1, confidence))

def result_with_confidence(symbol_type, confidence):
    """带置信度的结果输出"""
    if confidence < 0.5:
        return f'{symbol_type}(低置信度:{confidence:.2f})'
    return f'{symbol_type}(置信度:{confidence:.2f})'
    \end{lstlisting}
\end{frame}
